name: Upload to Transkribus

on:
  issues:
    types: [opened, edited]

permissions:
  contents: read
  issues: write

env:
  ISSUE_RESULT: ./issue-parser-result.json
  OUTPUT_LOG: ./output.log

jobs:
  upload:
    runs-on: ubuntu-latest
    # Only run if issue has the iiif-upload label
    if: contains(github.event.issue.labels.*.name, 'iiif-upload')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Check allowlist early
      - name: Check authorization
        id: auth-check
        run: |
          ALLOWLIST='${{ vars.ALLOWLIST }}'
          ACTOR='${{ github.actor }}'
          
          if echo "$ALLOWLIST" | jq -e --arg actor "$ACTOR" 'contains([$actor])' > /dev/null; then
            echo "authorized=true" >> $GITHUB_OUTPUT
            echo "✅ User $ACTOR is authorized"
          else
            echo "authorized=false" >> $GITHUB_OUTPUT
            echo "❌ User $ACTOR is NOT authorized"
          fi

      - name: Comment and close if unauthorized
        if: steps.auth-check.outputs.authorized != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ❌ Unauthorized\n\nUser @${context.actor} is not allowlisted to trigger Transkribus uploads.\n\n[Edit allowlist](https://github.com/organizations/dhbern/settings/variables/actions/ALLOWLIST)`
            });
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });
            core.setFailed('User not authorized');

      # Parse issue
      - name: Parse issue
        if: steps.auth-check.outputs.authorized == 'true'
        uses: stefanbuck/github-issue-parser@v3
        id: issue-parser
        with:
          template-path: .github/ISSUE_TEMPLATE/upload-transkribus.yml

      - name: Debug - show parsed issue
        if: steps.auth-check.outputs.authorized == 'true'
        run: |
          echo "=== Parsed issue data ==="
          cat ${HOME}/issue-parser-result.json
          cp ${HOME}/issue-parser-result.json ${{ env.ISSUE_RESULT }}

      - name: Set up Python
        if: steps.auth-check.outputs.authorized == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: steps.auth-check.outputs.authorized == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install requests requests-toolbelt lxml

      - name: Upload to Transkribus
        if: steps.auth-check.outputs.authorized == 'true'
        id: upload
        run: |
          python3 ./.github/scripts/iiif-to-transkribus.py
        env:
          ISSUE: ${{ env.ISSUE_RESULT }}
          OUTPUT_LOG: ${{ env.OUTPUT_LOG }}
          TRANSKRIBUS_CREDENTIALS: ${{ secrets.TRANSKRIBUS_CREDENTIALS }}
        continue-on-error: true

      - name: Read output log
        if: always() && steps.auth-check.outputs.authorized == 'true'
        id: read-log
        run: |
          if [ -f "${{ env.OUTPUT_LOG }}" ]; then
            echo "log_exists=true" >> $GITHUB_OUTPUT
            echo "log_content<<EOF" >> $GITHUB_OUTPUT
            cat "${{ env.OUTPUT_LOG }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "log_exists=false" >> $GITHUB_OUTPUT
            echo "log_content=No output log generated" >> $GITHUB_OUTPUT
          fi

      - name: Debug - cat output log
        if: always() && steps.auth-check.outputs.authorized == 'true'
        run: |
          echo "=== Upload output log ==="
          if [ -f "${{ env.OUTPUT_LOG }}" ]; then
            cat "${{ env.OUTPUT_LOG }}"
          else
            echo "No log file found"
          fi

      - name: Comment results to issue
        if: always() && steps.auth-check.outputs.authorized == 'true'
        uses: actions/github-script@v7
        env:
          LOG_CONTENT: ${{ steps.read-log.outputs.log_content }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const logContent = process.env.LOG_CONTENT || 'No output available';
            const status = logContent.includes('FAILED') || logContent.includes('ERROR') ? '❌ Upload encountered errors' : '✅ Upload completed';
            
            const body = `## ${status}\n\n### Upload Results\n\n\`\`\`\n${logContent}\n\`\`\`\n\n---\n*Workflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
